# JEE CBT Platform - Backend Server

Production-quality FastAPI backend for the JEE Computer-Based Test Platform.

## Features

- ✅ FastAPI with automatic API documentation
- ✅ MongoDB with Motor (async driver)
- ✅ JWT authentication
- ✅ Pydantic models for type safety
- ✅ Streaming AI reports with Gemini API
- ✅ Offline response upload support
- ✅ CORS configuration
- ✅ Admin & Student role-based access

## Setup

### 1. Install Dependencies

```bash
pip install -r requirements.txt
```

### 2. Configure Environment

Create a `.env` file in the root directory:

```env
PORT=8000
MONGODB_URI=mongodb://localhost:27017/jee_cbt_platform
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
ADMIN_LOGIN_CODE=123456
GEMINI_API_KEY=your-gemini-api-key-here
CORS_ORIGINS=http://localhost:3000,http://localhost:5173
```

### 3. Start MongoDB

```bash
# Using Docker
docker run -d -p 27017:27017 --name mongodb mongo:latest

# Or install MongoDB locally
# https://www.mongodb.com/docs/manual/installation/
```

### 4. Run the Server

```bash
# Development mode with auto-reload
python run.py

# Or using uvicorn directly
uvicorn src.server:app --reload --port 8000
```

### 5. Access API Documentation

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## Project Structure

```
/
├── src/
│   ├── server.py              # Main FastAPI application
│   ├── config.py              # Environment configuration
│   ├── database.py            # MongoDB connection
│   ├── models/                # Pydantic models
│   │   ├── user.py
│   │   ├── exam.py
│   │   └── submission.py
│   ├── controllers/           # Route handlers
│   │   ├── auth.py
│   │   ├── admin.py
│   │   └── exam.py
│   ├── middleware/            # Authentication middleware
│   │   └── auth.py
│   ├── services/              # External services
│   │   └── gemini.py
│   └── utils/                 # Helper functions
│       └── helpers.py
├── requirements.txt           # Python dependencies
├── .env.example              # Environment variables template
├── run.py                    # Application entry point
└── README.md                 # This file
```

## API Endpoints

### Authentication
- `POST /api/auth/admin/login` - Admin login
- `POST /api/auth/student/login` - Student login

### Admin (Protected)
- `GET /api/admin/exams` - Get all exams
- `POST /api/admin/exams` - Create new exam
- `PATCH /api/admin/exams/{exam_id}/close` - Close exam
- `POST /api/admin/exams/{exam_id}/key` - Upload answer key
- `POST /api/admin/exams/{exam_id}/generate-report` - Generate AI report (streaming)

### Exam (Protected)
- `GET /api/exams/{exam_id}/start` - Start exam and get questions
- `POST /api/exams/submit` - Submit exam online
- `POST /api/exams/upload-offline` - Upload offline encrypted response

## Key Features Explained

### JWT Authentication
- Tokens expire after 24 hours
- Role-based access control (Admin/Student)
- Secure token verification

### Streaming AI Reports
- Uses Server-Sent Events (SSE)
- Real-time report generation with Gemini API
- Handles connection failures gracefully

### Offline Response Upload
- Base64-encoded encrypted responses
- Automatic decoding and validation
- Saves to database with timestamp

## Development

### Running Tests
```bash
# Install pytest
pip install pytest pytest-asyncio httpx

# Run tests
pytest tests/ -v
```

### Code Quality
```bash
# Install linting tools
pip install black flake8 mypy

# Format code
black src/

# Check linting
flake8 src/

# Type checking
mypy src/
```

## Production Deployment

### Using Docker

Create `Dockerfile`:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["python", "run.py"]
```

Create `docker-compose.yml`:

```yaml
version: '3.8'

services:
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - MONGODB_URI=mongodb://mongo:27017/jee_cbt_platform
      - JWT_SECRET=${JWT_SECRET}
      - ADMIN_LOGIN_CODE=${ADMIN_LOGIN_CODE}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    depends_on:
      - mongo
    restart: unless-stopped

  mongo:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    restart: unless-stopped

volumes:
  mongo_data:
```

Run with Docker:
```bash
docker-compose up -d
```

### Environment Variables for Production

```env
PORT=8000
MONGODB_URI=mongodb://username:password@host:27017/jee_cbt_platform?authSource=admin
JWT_SECRET=use-a-very-long-random-secure-key-here
ADMIN_LOGIN_CODE=secure-admin-code-here
GEMINI_API_KEY=your-production-gemini-key
CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

## Security Best Practices

1. **Always use HTTPS in production**
2. **Set strong JWT_SECRET** - Use a cryptographically secure random string
3. **Rotate admin codes regularly**
4. **Enable MongoDB authentication**
5. **Use environment variables** - Never commit secrets to version control
6. **Rate limiting** - Consider adding rate limiting middleware
7. **Input validation** - Pydantic handles this automatically
8. **CORS** - Only allow trusted origins

## Troubleshooting

### MongoDB Connection Issues
```bash
# Check if MongoDB is running
mongosh --eval "db.adminCommand('ping')"

# Check connection string
echo $MONGODB_URI
```

### Port Already in Use
```bash
# Find process using port 8000
lsof -i :8000

# Kill the process
kill -9 <PID>
```

### Gemini API Errors
- Verify your API key is correct
- Check API quota and limits
- Ensure you're using the correct model name

## Performance Optimization

### Database Indexing
```python
# Add to src/database.py after connection
await exams_collection.create_index("accessCode", unique=True)
await exams_collection.create_index("status")
await submissions_collection.create_index([("userId", 1), ("examId", 1)])
```

### Caching
Consider adding Redis for:
- JWT token blacklisting
- Frequently accessed exam data
- Rate limiting counters

## Monitoring & Logging

### Add Structured Logging
```bash
pip install python-json-logger
```

```python
# src/logging_config.py
import logging
from pythonjsonlogger import jsonlogger

def setup_logging():
    logger = logging.getLogger()
    handler = logging.StreamHandler()
    formatter = jsonlogger.JsonFormatter()
    handler.setFormatter(formatter)
    logger.addHandler(handler)
    logger.setLevel(logging.INFO)
```

## API Response Examples

### Admin Login
```bash
curl -X POST http://localhost:8000/api/auth/admin/login \
  -H "Content-Type: application/json" \
  -d '{"code": "123456"}'
```

Response:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "name": "Admin User",
    "role": "ADMIN"
  }
}
```

### Create Exam
```bash
curl -X POST http://localhost:8000/api/admin/exams \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "title": "JEE Main Mock Test 1",
    "duration": 180,
    "totalQuestions": 75
  }'
```

### Student Login
```bash
curl -X POST http://localhost:8000/api/auth/student/login \
  -H "Content-Type: application/json" \
  -d '{"accessCode": "A4B9X2"}'
```

### Submit Exam
```bash
curl -X POST http://localhost:8000/api/exams/submit \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "userId": "507f1f77bcf86cd799439011",
    "examId": "507f1f77bcf86cd799439012",
    "serverHash": "a8x3n2f9",
    "startTime": "2025-11-06T10:00:00Z",
    "endTime": "2025-11-06T13:00:00Z",
    "answerSheet": {
      "1": "A",
      "2": ["B", "C"],
      "3": "42"
    },
    "questionStatuses": {
      "1": 2,
      "2": 2,
      "3": 2
    }
  }'
```

## Frontend Integration

### Update Frontend API Base URL

In your React app, create an API client:

```typescript
// src/lib/api.ts
const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';

export const api = {
  async adminLogin(code: string) {
    const response = await fetch(`${API_BASE_URL}/api/auth/admin/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
    return response.json();
  },
  
  async studentLogin(accessCode: string) {
    const response = await fetch(`${API_BASE_URL}/api/auth/student/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ accessCode })
    });
    return response.json();
  },
  
  // Add more methods as needed
};
```

### Environment Variables for Frontend

Create `.env.local` in your React app:
```env
VITE_API_URL=http://localhost:8000
GEMINI_API_KEY=your-gemini-key
```

## Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

This project is licensed under the MIT License.

## Support

For issues and questions:
- Open an issue on GitHub
- Check the API documentation at `/docs`
- Review logs for error details

## Changelog

### Version 1.0.0 (2025-11-06)
- Initial release
- Admin and Student authentication
- Exam management (CRUD operations)
- Answer key upload
- Online exam submission
- Offline response upload
- AI-powered performance reports with Gemini
- Real-time streaming reports with SSE
